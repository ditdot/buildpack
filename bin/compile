#!/bin/bash

BUILD=$1
CACHE_VERSION=v6
CACHE_ROOT=$2
CACHE=$CACHE_ROOT/versions/$CACHE_VERSION
ENV=$3

if [ ! -f $BUILD/run ]; then
	echo "Missing $BUILD/run"
	exit 1
fi

#set executable
chmod +x $BUILD/run

if [[ $STACK != cedar* ]]; then
	echo "Only cedar stacks are supported"
	exit 1
fi

rm -rf $CACHE

if [ -d $CACHE ]; then
	echo "Loading cache $CACHE_VERSION"
else
	echo "Build cache $CACHE_VERSION"

	rm -rf $ROOT_CACHE/versions
	mkdir -p $CACHE/local

	echo "Install Node"
	curl -s http://nodejs.org/dist/v0.12.0/node-v0.12.0-linux-x64.tar.gz | tar -C $CACHE/local -xzf -

	echo "Install Go"
	curl -s https://storage.googleapis.com/golang/go1.4.2.linux-amd64.tar.gz | tar -C $CACHE/local -xzf -

	echo "Create environment profile"

	mkdir -p $CACHE/.profile.d
	echo '#extra vars
	export GOPATH=$HOME/go
	export GOROOT=$HOME/local/go
	export NODE_BIN=$HOME/local/node-v0.12.0-linux-x64/bin
	PATH=$PATH:$HOME/local/go/bin:$GOPATH/bin:$NODE_BIN
	' > $CACHE/.profile.d/vars.sh
fi

echo "Set environment"
export GOPATH=$CACHE/go
export GOROOT=$CACHE/local/go
export NODE_BIN=$CACHE/local/node-v0.12.0-linux-x64/bin
export PATH=$PATH:$CACHE/local/go/bin:$GOPATH/bin:$NODE_BIN

#setup from cache
echo "Set files"
cp -r $CACHE/. $BUILD || exit 1

#print versions or die!
echo -n "node version "
node --version || exit 1
go version || exit 1

if [ -f $BUILD/compile ]; then
	echo "Running user 'compile' script"
	sh $BUILD/compile "$@" || exit 1
	rm $BUILD/compile
fi

exit 0