#!/bin/sh

BUILD=$1
CACHE=$2
ENV=$3

if [ ! -f $1/run ]; then
	echo "Missing $1/run"
	exit 1
fi

echo "Create Procfile"
echo 'web: ./run
worker: curl http://echo.jpillora.com/worker-run
' > $BUILD/Procfile

echo "Install Go"

mkdir $BUILD/local
curl -s https://storage.googleapis.com/golang/go1.4.2.linux-amd64.tar.gz | tar -C $BUILD/local -xzf -
GOROOT=$BUILD/local/go export GOROOT

GOPATH=$BUILD/go export GOPATH

mkdir $GOPATH
PATH=$PATH:$BUILD/local/go/bin:$GOPATH/bin export PATH

mkdir -p $BUILD/.profile.d
echo 'GOPATH=$HOME/go' > $BUILD/.profile.d/go.sh
echo 'PATH=$PATH:$HOME/local/go/bin:$GOPATH/bin' > $BUILD/.profile.d/path.sh

#print version
go version

echo "Found run script '$BUILD/run'"
chmod +x $BUILD/run

if [ -f $BUILD/compile ]; then
	echo "running user compile script..."
	sh $BUILD/compile "$@"
fi


echo "Compiled!"

exit 0



